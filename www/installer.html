<!doctype html>
<html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>NexoWatt – Installer</title>
<link rel="stylesheet" href="/adapter/nexowatt-vis/styles.css">
<script src="/socket.io/socket.io.js"></script>
<style>
body{ background:#0f1317; color:#e6edf3; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; padding:16px }
.wrap{ max-width:1100px; margin:0 auto }
.card{ background:#12171c; border:1px solid #2a323b; border-radius:16px; padding:18px; margin-bottom:14px }
.row{ display:flex; gap:14px; flex-wrap:wrap; align-items:center }
.tile{ flex:1 1 280px; background:#a7cf16; color:#111; border-radius:10px; padding:14px 16px; font-size:18px; font-weight:600 }
.tile small{display:block; opacity:.75; margin-bottom:6px }
input[type="number"], input[type="text"]{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid #2a323b; background:#0f1317; color:#e6edf3 }
.switch{ display:flex; align-items:center; gap:10px } .switch input{ transform: scale(1.2); }
.btn{ padding:10px 14px; border:1px solid #39424c; border-radius:10px; background:#1b2229; color:#e6edf3; cursor:pointer } .btn:hover{ background:#242c34 }
.ovl{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); z-index:1000;}
.ovl .box{ background:#12171c; border:1px solid #2a323b; border-radius:16px; padding:20px; width:min(420px,92vw) }
.muted{ color:#9aa4af }
</style></head><body>

<div id="pinOvl" class="ovl" style="display:none">
  <div class="box">
    <h2>Installer – PIN</h2>
    <p id="pinHint" class="muted" style="margin-top:-8px"></p>
    <div style="display:flex; gap:10px; margin:10px 0 6px">
      <input id="pin" type="password" placeholder="PIN" style="flex:1">
      <button id="pinOk" class="btn">Öffnen</button>
    </div>
    <div id="pinErr" style="color:#ff6e6e;display:none">Falsche PIN</div>
  </div>
</div>

<div class="wrap">
  <h1 style="margin:8px 0 14px">Installer</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Netzanschluss</h2>
      <label class="switch"><span class="muted">§14a</span><input id="s_14a" type="checkbox"></label>
    </div>
    <div class="row" style="margin-top:12px">
      <div class="tile"><small>Leistung Netzanschluss</small><input id="n_grid" type="number"><div class="muted">W</div></div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px">Emobility</h2>
    <div class="row">
      <div class="tile"><small>Anzahl Ladepunkte</small><input id="n_cpoints" type="number"><div class="muted">Stk</div></div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px">Farm</h2>
    <div class="row">
      <div class="tile"><small>Anzahl Speicher</small><input id="n_farmCount" type="number"><div class="muted">Stk</div></div>
      <div class="tile"><small>Leistung Speicher</small><input id="n_farmPower" type="number"><div class="muted">W</div></div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px">Multi-Use</h2>
    <div class="row">
      <div class="tile"><small>BetriebsModus EMS</small><input id="n_mode" type="number" min="1" max="3"><div class="muted">1=Normal 2=Lastspitze 3=Multi-Use</div></div>
      <div class="tile"><small>SOC Min</small><input id="n_socMin" type="number" min="0" max="100"><div class="muted">%</div></div>
      <div class="tile"><small>SOC Bereich Lastspitze</small><input id="n_socPeak" type="number" min="0" max="100"><div class="muted">%</div></div>
      <div class="tile"><small>Beladeleistung max</small><input id="n_maxCh" type="number"><div class="muted">W (neg)</div></div>
      <div class="tile"><small>Entladeleistung max</small><input id="n_maxDis" type="number"><div class="muted">W</div></div>
    </div>
  </div>

  <div style="display:flex; gap:10px; margin-top:12px">
    <a class="btn" href="/adapter/nexowatt-vis/settings.html">Startseite</a>
    <a class="btn" id="btnAdmin" href="/adapter/nexowatt-vis/" target="_blank" rel="noopener">NexoWatt Admin</a>
  </div>
</div>

<script>
const base = '0_userdata.0.EMS.';
const dp = {
  pinEn: base+'installer.enabled', pinHash: base+'installer.pinHash', pinHint: base+'installer.hint', unlocked: base+'installer.unlocked', linkAdmin: base+'installer.linkAdmin',
  s14a: base+'regulation.section14aEnabled', grid: base+'grid.connectionPowerW', cpoints: base+'emobility.chargePointsCount',
  farmCount: base+'farm.storageCount', farmPower: base+'farm.storagePowerW',
  mode: base+'multiUse.mode', socMin: base+'multiUse.socMin', socPeak: base+'multiUse.peakSocPercent',
  maxCh: base+'multiUse.maxChargeW', maxDis: base+'multiUse.maxDischargeW',
};
const socket = io('/', {path:'/socket.io'});
function getState(id){ return new Promise(res => socket.emit('getState', id, (e, st)=>res(st && st.val))); }
function setState(id,val){ socket.emit('setState', id, val); }
async function sha256(txt){ const b=new TextEncoder().encode(txt); const h=await crypto.subtle.digest('SHA-256',b); return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2,'0')).join(''); }

(async ()=>{
  // PIN Gate
  const usePin = !!(await getState(dp.pinEn));
  const unlocked = !!(await getState(dp.unlocked));
  const ovl = document.getElementById('pinOvl');
  if (usePin && !unlocked){
    ovl.style.display='flex';
    document.getElementById('pinHint').textContent = (await getState(dp.pinHint)) || '';
    const serverHash = await getState(dp.pinHash);
    document.getElementById('pinOk').onclick = async ()=>{
      const pin = (document.getElementById('pin').value || '').trim();
      const hash = await sha256(pin);
      if (hash === serverHash){ await setState(dp.unlocked, true); ovl.style.display='none'; }
      else { document.getElementById('pinErr').style.display='block'; }
    };
  }

  const la = (await getState(dp.linkAdmin)) || '/adapter/nexowatt-vis/';
  document.getElementById('btnAdmin').href = la;

  // read
  document.getElementById('s_14a').checked = !!(await getState(dp.s14a));
  document.getElementById('n_grid').value = (await getState(dp.grid)) ?? 10000;
  document.getElementById('n_cpoints').value = (await getState(dp.cpoints)) ?? 3;
  document.getElementById('n_farmCount').value = (await getState(dp.farmCount)) ?? 0;
  document.getElementById('n_farmPower').value = (await getState(dp.farmPower)) ?? 0;
  document.getElementById('n_mode').value = (await getState(dp.mode)) ?? 1;
  document.getElementById('n_socMin').value = (await getState(dp.socMin)) ?? 0;
  document.getElementById('n_socPeak').value = (await getState(dp.socPeak)) ?? 10;
  document.getElementById('n_maxCh').value = (await getState(dp.maxCh)) ?? -5000;
  document.getElementById('n_maxDis').value = (await getState(dp.maxDis)) ?? 5000;

  // write
  document.getElementById('s_14a').addEventListener('change', e=> setState(dp.s14a, e.target.checked));
  document.getElementById('n_grid').addEventListener('change', e=> setState(dp.grid, parseInt(e.target.value,10)));
  document.getElementById('n_cpoints').addEventListener('change', e=> setState(dp.cpoints, parseInt(e.target.value,10)));
  document.getElementById('n_farmCount').addEventListener('change', e=> setState(dp.farmCount, parseInt(e.target.value,10)));
  document.getElementById('n_farmPower').addEventListener('change', e=> setState(dp.farmPower, parseInt(e.target.value,10)));
  document.getElementById('n_mode').addEventListener('change', e=> setState(dp.mode, parseInt(e.target.value,10)));
  document.getElementById('n_socMin').addEventListener('change', e=> setState(dp.socMin, parseInt(e.target.value,10)));
  document.getElementById('n_socPeak').addEventListener('change', e=> setState(dp.socPeak, parseInt(e.target.value,10)));
  document.getElementById('n_maxCh').addEventListener('change', e=> setState(dp.maxCh, parseInt(e.target.value,10)));
  document.getElementById('n_maxDis').addEventListener('change', e=> setState(dp.maxDis, parseInt(e.target.value,10)));
})();
</script>
</body></html>